(function(e){e.fn.photoClip=function(g){if(!window.FileReader){alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");return}var f={width:200,height:200,file:"",view:"",ok:"",strictSize:false,loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};e.extend(f,g);this.each(function(){c(this,f)});return this};function a(f,g,h){var i=new Image();i.onload=function(){var m=0,r,o,k,q;r=this.naturalWidth;o=this.naturalHeight;var n=Math.max(r,o);if(n>1024){var p=Math.min(r,o);p=p/n*1024;n=1024;if(r>o){r=n;o=p}else{r=p;o=n}}var l=document.createElement("canvas");l.width=k=r;l.height=q=o;var j=l.getContext("2d");switch(g){case 3:m=180;r=-k;o=-q;break;case 6:l.width=q;l.height=k;m=90;r=k;o=-q;break;case 8:l.width=q;l.height=k;m=270;r=-k;o=q;break}j.rotate(m*Math.PI/180);j.drawImage(this,0,0,r,o);h(l.toDataURL("image/png"))};i.src=f}function c(P,R){var A=R.width,L=R.height,y=R.file,j=R.view,O=R.ok,ab=R.strictSize,T=R.loadStart,u=R.loadComplete,W=R.loadError,U=R.clipFinish;var H=e(y);if(!H.length){return}var ag,z,i,K;H.attr("accept","image/*");H.change(function(){if(!this.files.length){return}if(!/image\/\w+/.test(this.files[0].type)){alert("图片格式不正确，请选择正确格式的图片文件！");return false}else{e("#lazy_tip").show();var ah=new FileReader();var aj=this.files[0];var ai;EXIF.getData(aj,function(){ai=EXIF.getTag(this,"Orientation")});ah.onprogress=function(ak){console.log((ak.loaded/ak.total*100).toFixed()+"%")};ah.onload=function(am){e("#lazy_tip").hide();var al=am.total/1024;if(al>1024){var an=1024/al;var ak=e("<img>").hide();ak.load(function(){ak.appendTo(document.body);if(navigator.userAgent.match(/iphone/i)){a(am.target.result,ai,function(ap){g(ap)})}else{var ao=E(this,an);g(ao)}});ak.attr("src",this.result)}else{if(navigator.userAgent.match(/iphone/i)){a(am.target.result,ai,function(ao){g(ao)})}else{g(this.result)}}};ah.onerror=function(ak){alert("图片加载失败");W.call(this,ak)};ah.readAsDataURL(this.files[0]);e("#hit").attr("fileName",this.files[0].name);T.call(ah,this.files[0])}});H.click(function(){this.value=""});var o,V,aa,F,r,p,m,v,Z;Y();C();q();D();var B=e(O);if(B.length){B.click(function(){e(".lazy_cover,.lazy_tip").show();l()})}var J=e(window);x();J.resize(x);var Q,af,ad,f;function ae(){K=true;F.append(this);ac.call(this,ag,function(){z=this.naturalWidth;i=this.naturalHeight});ac(aa,function(){s()});u.call(this,this.src)}function C(){var ah={zoom:true,scrollX:true,scrollY:true,freeScroll:true,mouseWheel:true,wheelAction:"zoom"};m=new IScroll(V[0],ah)}function s(){af=0;ad=0;f=0;F.css({"width":z,"height":i});k(F,af,ad,f);w(z,i);m.zoom(m.options.zoomStart);n(z,i);var ai=(A-z*m.options.zoomStart)*0.5,ah=(L-i*m.options.zoomStart)*0.5;m.scrollTo(ai,ah)}function n(ai,ah){aa.css({"width":ai,"height":ah});V.append(aa);m.refresh()}function q(){var ai=!!navigator.userAgent.match(/mobile/i);if(ai){var ah=new Hammer(aa[0]);ah.add(new Hammer.Rotate());var aj,ak;ah.on("rotatemove",function(al){if(Q){return}aj=al.rotation;if(aj>180){aj-=360}else{if(aj<-180){aj+=360}}ak=aj>0?1:aj<0?-1:0});ah.on("rotateend",function(al){if(Q){return}if(Math.abs(aj)>30){if(ak==1){N(al.center)}else{if(ak==-1){S(al.center)}}}})}else{aa.on("dblclick",function(al){N({x:al.clientX,y:al.clientY})})}}function N(ah){M(90,ah)}function S(ah){M(-90,ah)}function M(ai,ao){if(Q){return}Q=true;var am;if(!ao){am=h(aa,V,A*0.5,L*0.5)}else{am=I(aa,ao.x,ao.y)}var an=X(f,am),au=an.x,at=an.y,ak=0,aj=0,ar=0,aq=0,al=f+ai,ah,ap;if(al==90||al==-270){ak=au+at;aj=at-au;if(al>f){ar=i-au-at;aq=au-at}else{if(al<f){ar=(i-at)-(z-au);aq=au+at-i}}ah=i;ap=z}else{if(al==180||al==-180){ak=au*2;aj=at*2;if(al>f){ar=(z-au)-(i-at);aq=i-(au+at)}else{if(al<f){ar=z-(au+at);aq=(i-at)-(z-au)}}ah=z;ap=i}else{if(al==270||al==-90){ak=au-at;aj=au+at;if(al>f){ar=au+at-z;aq=(z-au)-(i-at)}else{if(al<f){ar=at-au;aq=z-au-at}}ah=i;ap=z}else{if(al==0||al==360||al==-360){ak=0;aj=0;if(al>f){ar=au-at;aq=au+at-z}else{if(al<f){ar=au+at-i;aq=at-au}}ah=z;ap=i}}}}if(f==0){af=0;ad=0}else{if(f==90||f==-270){af-=au+at;ad-=at-au}else{if(f==180||f==-180){af-=au*2;ad-=at*2}else{if(f==270||f==-90){af-=au-at;ad-=au+at}}}}af=af.toFixed(2)-0;ad=ad.toFixed(2)-0;k(F,af,ad,f,au,at);t(F,af,ad,al,200,function(){Q=false;f=al%360;af+=ak+ar;ad+=aj+aq;af=af.toFixed(2)-0;ad=ad.toFixed(2)-0;k(F,af,ad,f);m.scrollTo(m.x-ar*m.scale,m.y-aq*m.scale);w(ah,ap);if(m.scale<m.options.zoomMin){m.zoom(m.options.zoomMin)}n(ah,ap)})}function D(){p=document.createElement("canvas");p.width=A;p.height=L}function l(){if(!K){alert("亲，当前没有图片可以裁剪!");e(".lazy_cover,.lazy_tip").hide();return}var ai=h(aa,V);var ak=m.scale;var ah=p.getContext("2d");ah.clearRect(0,0,p.width,p.height);ah.save();if(ab){ah.scale(ak,ak)}else{p.width=A/ak;p.height=L/ak}ah.translate(af-ai.x/ak,ad-ai.y/ak);ah.rotate(f*Math.PI/180);ah.drawImage(ag[0],0,0);ah.restore();var aj=p.toDataURL("image/jpeg");r.css("background-image","url("+aj+")");U.call(ag[0],aj);e(".lazy_cover,.lazy_tip").hide()}function x(){ac(o,function(){v=o.width();Z=o.height()})}function h(ak,aj,ai,am){ai=ai||0;
am=am||0;var ah,al;ac(ak,function(){ah=ak.offset()});ac(aj,function(){al=aj.offset()});return{x:al.left-ah.left+ai,y:al.top-ah.top+am}}function I(ai,ah,ak){ah=ah||0;ak=ak||0;var aj;ac(ai,function(){aj=ai.offset()});return{x:ah+J.scrollLeft()-aj.left,y:ak+J.scrollTop()-aj.top}}function ac(aj,ai){var ah=e();e.each(aj,function(al,ao){var am=e(ao);var an=am.parents().andSelf().filter(":hidden");var ak;for(var al=0;al<an.length;al++){if(!am.is(":hidden")){break}ak=an.eq(al);if(ak.css("display")=="none"){ah=ah.add(ak.show())}}});if(typeof(ai)=="function"){ai.call(this)}ah.hide()}function X(ak,ah){var aj=m.scale;var ai={};if(ak==0){ai.x=ah.x/aj;ai.y=ah.y/aj}else{if(ak==90||ak==-270){ai.x=ah.y/aj;ai.y=i-ah.x/aj}else{if(ak==180||ak==-180){ai.x=z-ah.x/aj;ai.y=i-ah.y/aj}else{if(ak==270||ak==-90){ai.x=z-ah.y/aj;ai.y=ah.x/aj}}}}return ai}function G(ai,ak,ah,aj){var am=ai/ah;var al=ak/aj;return am>al?am:al}function w(ai,ah){m.options.zoomMin=G(A,L,ai,ah);m.options.zoomMax=Math.max(1,m.options.zoomMin);m.options.zoomStart=Math.min(m.options.zoomMax,G(v,Z,ai,ah))}function E(an,ap,ai,am){ap=ap||0.8;ai=ai||0;var ah="image/jpeg";if(am!=undefined&&am=="png"){ah="image/png"}var ar=an.naturalWidth,al=an.naturalHeight;var ak=Math.max(ar,al);if(ak>1024){var ao=Math.min(ar,al);ao=ao/ak*1024;ak=1024;if(ar>al){ar=ak;al=ao}else{ar=ao;al=ak}}var aj=document.createElement("canvas");var aq=aj.getContext("2d");if(ai){aj.width=al;aj.height=ar;aq.translate(al,0);aq.rotate(ai*Math.PI/180)}else{aj.width=ar;aj.height=al}aq.drawImage(an,0,0,ar,al);var at=aj.toDataURL(ah,ap||0.8);return at}function g(ah){if(ag&&ag.length){ag.remove();delete ag[0]}ag=e("<img>").css({"user-select":"none","pointer-events":"none"});ag.load(ae);ag.attr("src",ah)}function k(an,ah,am,al,aj,ai){aj=aj||0;ai=ai||0;var ak={};ak[d+"transform"]="translateZ(0) translate("+ah+"px,"+am+"px) rotate("+al+"deg)";ak[d+"transform-origin"]=aj+"px "+ai+"px";an.css(ak)}function t(am,ah,al,ak,aj,ai){am.css(d+"transform");am.css(d+"transition",d+"transform "+aj+"ms");am.one(b,function(){am.css(d+"transition","");ai.call(this)});am.css(d+"transform","translateZ(0) translate("+ah+"px,"+al+"px) rotate("+ak+"deg)")}function Y(){o=e(P).css({"user-select":"none","overflow":"hidden"});if(o.css("position")=="static"){o.css("position","relative")}V=e("<div class='photo-clip-view'>").css({"position":"absolute","left":"50%","top":"50%","width":A,"height":L,"margin-left":-A/2,"margin-top":-L/2}).appendTo(o);aa=e("<div class='photo-clip-moveLayer'>").appendTo(V);F=e("<div class='photo-clip-rotateLayer'>").appendTo(aa);var al=e("<div class='photo-clip-mask'>").css({"position":"absolute","left":0,"top":0,"width":"100%","height":"100%","pointer-events":"none"}).appendTo(o);var ai=e("<div class='photo-clip-mask-left'>").css({"position":"absolute","left":0,"right":"50%","top":"50%","bottom":"50%","width":"auto","height":L,"margin-right":A/2,"margin-top":-L/2,"margin-bottom":-L/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(al);var ak=e("<div class='photo-clip-mask-right'>").css({"position":"absolute","left":"50%","right":0,"top":"50%","bottom":"50%","margin-left":A/2,"margin-top":-L/2,"margin-bottom":-L/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(al);var am=e("<div class='photo-clip-mask-top'>").css({"position":"absolute","left":0,"right":0,"top":0,"bottom":"50%","margin-bottom":L/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(al);var aj=e("<div class='photo-clip-mask-bottom'>").css({"position":"absolute","left":0,"right":0,"top":"50%","bottom":0,"margin-top":L/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(al);var ah=e("<div class='photo-clip-area'>").css({"border":"1px dashed #ddd","position":"absolute","left":"50%","top":"50%","width":A,"height":L,"margin-left":-A/2-1,"margin-top":-L/2-1}).appendTo(al);r=e(j);if(r.length){r.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}}}var d="",b;(function(){var h,k={Webkit:"webkit",Moz:"",O:"o"},j=document.documentElement,f=function(i){return h?h+i:i.toLowerCase()};for(var g in k){if(j.style[g+"TransitionProperty"]!==undefined){d="-"+g.toLowerCase()+"-";h=k[g];break}}b=f("TransitionEnd")})()})(jQuery);